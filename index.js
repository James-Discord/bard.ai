const express = require('express');
const axios = require('axios');
const fs = require('fs');

const app = express();
app.use(express.json());

let sessionToken = '';

function getSessionToken() {
  try {
    sessionToken = fs.readFileSync('sessionToken.txt', 'utf8').trim();
  } catch (error) {
    console.error('Error reading session token:', error);
  }
}

getSessionToken();

app.get('/answer', async (req, res) => {
  try {
    const question = req.query.question;
    if (!question) {
      res.status(400).json({ error: 'Missing question parameter' });
      return;
    }

    const _bard = new bardapi();
    const answer = await _bard.getAnswer(question);
    res.json({ answer });
  } catch (error) {
    console.error('Error fetching answer:', error);
    res.status(500).json({ error: 'An error occurred while fetching the answer' });
  }
});

app.all('/ask-gpt', async (req, res) => {
  try {
    const question = req.query.question || req.body.question;
    if (!question) {
      res.status(400).json({ error: 'Missing question parameter' });
      return;
    }

    const response = await axios.post('https://api.pawan.krd/v1/chat/completions', {
      model: 'gpt-3.5-turbo',
      max_tokens: 100,
      messages: [
        { role: 'system', content: 'You are a helpful assistant.' },
        { role: 'user', content: question }
      ]
    }, {
      headers: {
        'Authorization': `Bearer ${sessionToken}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.status !== 200) {
      console.error('Error response from GPT API:', response.status);
      res.status(500).json({ error: 'An error occurred while fetching the answer from GPT' });
      return;
    }

    const { choices } = response.data;
    if (!choices || choices.length === 0) {
      console.error('No choices received from GPT API');
      res.status(500).json({ error: 'An error occurred while fetching the answer from GPT' });
      return;
    }

    const answer = choices[0].message.content;
    res.json({ answer });
  } catch (error) {
    console.error('Error fetching answer from GPT:', error);
    res.status(500).json({ error: 'An error occurred while fetching the answer from GPT' });
  }
});

app.listen(3000, () => {
  console.log('Server listening on port 3000');
});
